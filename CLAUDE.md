# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Runtipi App Store repository containing self-hosted application definitions. Runtipi uses a dynamic JSON-based format (v2 schema) to define Docker containers rather than traditional docker-compose.yml files.

## Commands

**Full validation (Docker-based, CI equivalent):**

```bash
make test
```

**Local development:**

```bash
bun install --ignore-scripts
bun run lint          # Biome check with auto-fix
bun test              # Run tests + validate JSON schemas
```

**Run a single test (by app name):**

```bash
bun test --test-name-pattern "nginx"
```

**Generate README from apps:**

```bash
make readme
```

**Test Renovate configuration:**

```bash
make renovate-test
```

## App Structure

Each app lives in `apps/<app-id>/` with:

- `config.json` - App metadata (required fields validated in tests, `version` tracked by Renovate)
- `docker-compose.json` - Container definition using schemaVersion 2 (validated against `apps/dynamic-compose-schema.json` via AJV and `parseComposeJson` from `@runtipi/common`)
- `metadata/logo.jpg` - App logo
- `metadata/description.md` - Full description

### config.json Required Fields

`id`, `name`, `available`, `tipi_version`, `short_desc`, `author`, `source`

Optional but common: `port`, `categories`, `version`, `website`, `exposable`, `dynamic_config`, `supported_architectures`, `form_fields`, `min_tipi_version`, `created_at`, `updated_at`

**Form field rules:** Fields with `type: "random"` must NOT have `required: true` (they are auto-generated by Tipi). Tests enforce this.

### docker-compose.json Format

Uses dynamic compose schema v2 (`schemaVersion: 2`) with a `services` array. Key differences from standard docker-compose:

- `internalPort` instead of exposed ports
- `isMain: true` marks the primary service (also used by `scripts/update-config.ts` to determine which image version maps to `config.json` version)
- `hostPath`/`containerPath` for volumes using `${APP_DATA_DIR}` variable
- Environment as array of `{key, value}` objects (not key=value strings)
- `dependsOn` uses object form with `condition: "service_healthy"` for database dependencies
- User-configurable values reference `${VARIABLE_NAME}` from `config.json` `form_fields`

## Validation

Tests in `apps/__tests__/apps.test.ts` check:

1. Required files exist (`config.json`, `docker-compose.json`, `metadata/logo.jpg`, `metadata/description.md`)
2. `config.json` has all required fields with valid values
3. `docker-compose.json` validates against JSON schema (AJV) and `parseComposeJson` from `@runtipi/common`
4. All apps have unique ports and unique ids
5. All apps have valid `created_at` and `updated_at` timestamps
6. Random form fields are not marked as required

The `test` script also runs `scripts/validate-json.js` which validates all `docker-compose.json` files against the local schema.

CI runs `bun test` and `bun run lint:ci` (Biome, only changed files, warnings as errors) on every PR and push to master.

## Code Style

Biome with double quotes, 2-space indent, 150 char line width, LF line endings. Run `bun run lint` to auto-fix.

## Renovate (Automatic Updates)

Renovate (GitHub App hosted) monitors `docker-compose.json` and `config.json` files for Docker image updates.

**Update flow (dual safety):**

1. Renovate detects new Docker image version
2. Renovate creates PR updating image tags in `docker-compose.json` AND version in `config.json` (via per-app customManagers)
3. GitHub Action (`update-tipi-version.yml`) triggers on the PR, runs `scripts/update-config.ts` to update `version` (only for `isMain` service), increment `tipi_version` (+1), update `updated_at`, and lint the result

Both Renovate and the workflow update `config.json` version for redundancy - if either fails, the other covers it.

**Configuration structure** (`renovate.json`):

- First customManager matches ALL `docker-compose.json` files (extracts image name dynamically)
- Per-app customManagers match `config.json` files to update version field
- PostgreSQL/MySQL/Redis images are disabled (won't auto-update)
- Uses `pull_request_target` event so the workflow can push back to Renovate branches

**`scripts/update-config.ts`** accepts 3 arguments: `<packageFile> <newVersion> [packageName]`. When `packageName` is provided, it only updates `config.json` version if the main service (`isMain: true`) matches that package.

## Adding a New App

1. Create `apps/<app-id>/` directory with:
   - `config.json` - App metadata
   - `docker-compose.json` - Container definition (`schemaVersion: 2`)
   - `metadata/logo.jpg` - Logo image (convert from PNG: `sips -s format jpeg input.png --out logo.jpg`)
   - `metadata/description.md` - Markdown description

2. For apps with databases, add a second service in `docker-compose.json` with `dependsOn` and `healthCheck` (see `apps/workout-cool/docker-compose.json` for a clean 2-service example, or `apps/n8n/docker-compose.json` for a 4-service setup with PostgreSQL, Redis, and a worker)

3. Add entry to `renovate.json` customManagers for the new app's `config.json`:

   ```json
   {
     "customType": "regex",
     "managerFilePatterns": ["apps/<app-id>/config.json"],
     "matchStrings": ["\"version\":\\s*\"(?<currentValue>[^\"]+)\""],
     "depNameTemplate": "<docker-image-name>",
     "datasourceTemplate": "docker"
   }
   ```

4. Run `make test` and `make renovate-test` to validate

5. Commit files (Renovate needs them in git to detect updates)

**Gotchas:**

- When adding apps with Redis caching (e.g., Django apps), ensure all services that use the cache include required client configuration environment variables. Missing cache config causes `ImproperlyConfigured` container crashes that only appear at runtime, not during validation.
- For queue-mode apps (e.g., n8n), the main service and workers must share the same encryption key and image version. Workers use `command: "worker"` and need identical DB/Redis environment variables as the main service.
- Apps using `version: "latest"` in config.json (e.g., wger) don't need a per-app customManager in `renovate.json` since there's no semver to track.
